name: Deploy to Vercel and notify n8n

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Deploy to Vercel (Production)
        id: vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: .
          scope: ${{ secrets.VERCEL_ORG_ID }}
          prod: true

      - name: Prepare payload for n8n
        id: payload
        run: |
          STATUS="success"
          if [ "${{ job.status }}" != "success" ]; then STATUS="failure"; fi
          URL="${{ steps.vercel.outputs.preview-url }}"
          DEPLOY_ID="${{ steps.vercel.outputs.preview-id }}"
          COMMIT_SHA="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"
          PROJECT="${{ github.repository }}"
          echo "json={\"status\":\"$STATUS\",\"url\":\"$URL\",\"deploymentId\":\"$DEPLOY_ID\",\"commitSha\":\"$COMMIT_SHA\",\"branch\":\"$BRANCH\",\"project\":\"$PROJECT\",\"createdAt\":$(date +%s000)}" >> $GITHUB_OUTPUT

      - name: Notify n8n
        if: always()
        run: |
          curl -s -X POST "$N8N_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '${{ steps.payload.outputs.json }}'
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
